import requests
import multiprocessing

SUBMITTER_SERVER = "http://172.31.14.5:5000/submit"
ATTDEF_SERVER = "http://172.31.8.194:5000/api/v2/"

TOKEN = 'eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJmcmVzaCI6ZmFsc2UsImlhdCI6MTcyMzQzMDc4MSwianRpIjoiMWU1MGJiOTYtMmY5OC00ODZmLWFkMmUtNmYzNDY3ZjRmZTcwIiwidHlwZSI6ImFjY2VzcyIsInN1YiI6eyJ0ZWFtIjp7ImlkIjoxLCJuYW1lIjoiU3RlbWJhMSJ9fSwibmJmIjoxNzIzNDMwNzgxLCJjc3JmIjoiYTJmODVlNzQtOThlMy00OGQ2LWIyOGQtNjE3MGU3ZDg2OTI1IiwiZXhwIjoxNzIzNDczOTgxfQ.jULSfl7RiRV2zoC9ZfKnzLvluRntsgLNg57siqRduPPeTHXJmFmh9yu3DutSjm-AHBL3731BneNNN2sBpyh1_w'

CHALL_ID = '1'
CHALL_PORT = 10004

def exploit(target, port):
  try:
    flag = ""
    
    if not flag:
      raise Exception("Flag not found")
    
    return flag
  except Exception as e:
    print(f"[-] Error: {e}")

def process_exploit(target_ip, port):
  try:
    print(f"[+] Target IP: {target_ip}")
      
    flag = exploit(target_ip, CHALL_PORT)
    
    if not flag:
      print("[-] Exploit failed")
      return
      
    print(f"[+] Flag: {flag}")
      
    requests.post(SUBMITTER_SERVER, json={'flag': [flag]})
  except Exception as e:
    print(f"[-] Error: {e}")

def main():
  target_ip_list = requests.get(ATTDEF_SERVER + "services", headers={'Authorization': f'Bearer {TOKEN}'}).json()['data'][CHALL_ID]
    
  while True:
    for target_id, target_ip in target_ip_list.items():
      process = multiprocessing.Process(target=process_exploit, args=(target_ip, CHALL_PORT))
      process.start()
    
    time.sleep(300)
  

if __name__ == "__main__":
  main()