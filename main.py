import requests
import multiprocessing
import time

SUBMITTER_SERVER = "http://IP_VPN/submit"
ATTDEF_SERVER = "https://and.idcyberskills.com/api/v2/"

TOKEN = open('/tmp/token.txt').read().strip()

if not TOKEN:
  print("[-] Token not found")
  exit()

CHALL_ID = '1'
CHALL_PORT = 10004

def exploit(target, port):
  try:
    flag = ""
    
    if not flag:
      raise Exception("Flag not found")
    
    return flag
  except Exception as e:
    print(f"[-] Error: {e} ({target})")

def process_exploit(target_ip, port):
  try:
    print(f"[+] Target IP: {target_ip}")
      
    flag = exploit(target_ip, CHALL_PORT)
    
    if not flag:
      print("[-] Exploit failed")
      return
      
    print(f"[+] Flag: {flag}")
      
    requests.post(SUBMITTER_SERVER, json={'flag': [flag]})
  except Exception as e:
    print(f"[-] Error: {e}")

def main():
  target_ip_list = requests.get(ATTDEF_SERVER + "services", headers={'Authorization': f'Bearer {TOKEN}'}).json()['data'][CHALL_ID]
  
  timer = 0 # in seconds (TICK)
    
  while True:
    if timer > 0:
      print(f"[+] Next Exploit in: {timer} seconds", end="\r")
      timer -= 1
      time.sleep(1)
      continue
    
    for target_id, target_ip in target_ip_list.items():
      process = multiprocessing.Process(target=process_exploit, args=(target_ip, CHALL_PORT))
      process.start()

    timer = 300

if __name__ == "__main__":
  main()
